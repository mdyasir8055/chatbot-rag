<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Consultant - RAG Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Left Sidebar */
        .left-sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #f1f5f9;
        }

        .sidebar-title {
            font-size: 20px;
            font-weight: 700;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .title-underline {
            height: 3px;
            width: 60px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .sidebar-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .upload-tabs {
            display: flex;
            margin-bottom: 16px;
            background: #f8fafc;
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 8px 16px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .tab.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab:not(.active) {
            color: #64748b;
        }

        .upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 32px 16px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafbfc;
        }

        .upload-box:hover {
            border-color: #2563eb;
            background: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
        }

        .upload-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .section-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            color: #2563eb;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: #4b5563;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .checkbox {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            accent-color: #2563eb;
        }

        .checkbox-label {
            font-size: 13px;
            color: #4b5563;
        }

        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn.purple {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .action-btn.purple:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(124, 58, 237, 0.4);
        }

        .action-btn.green {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .action-btn.green:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
        }

        .status-section {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .status-title {
            font-size: 13px;
            font-weight: 600;
            color: #dc2626;
            margin-bottom: 8px;
        }

        .status-message {
            font-size: 12px;
            color: #7f1d1d;
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 24px 32px;
            border-bottom: 1px solid #f1f5f9;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .chat-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 24px;
            animation: fadeIn 0.4s ease-out;
        }

        .message-row {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message-row.user {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .avatar.bot {
            background: #4b5563;
            color: white;
        }

        .avatar.user {
            background: #2563eb;
            color: white;
        }

        .message-content {
            max-width: 70%;
            background: white;
            padding: 16px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
        }

        .message-content.user {
            background: #2563eb;
            color: white;
            border: none;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
        }

        .message-timestamp {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 8px;
            text-align: right;
        }

        .page-references {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .page-ref {
            background: #eff6ff;
            color: #2563eb;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #dbeafe;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-ref:hover {
            background: #dbeafe;
            transform: translateY(-1px);
        }

        .escalate-btn {
            background: #fef2f2;
            color: #dc2626;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid #fecaca;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s ease;
        }

        .escalate-btn:hover {
            background: #fecaca;
            transform: translateY(-1px);
        }

        .typing-indicator {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 24px;
        }

        .typing-dots {
            background: white;
            padding: 16px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }

        .quick-replies {
            padding: 16px 32px;
            background: white;
            border-top: 1px solid #f1f5f9;
        }

        .quick-reply-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quick-reply {
            padding: 8px 16px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 13px;
            color: #4b5563;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-reply:hover {
            background: #eff6ff;
            border-color: #2563eb;
            color: #2563eb;
            transform: translateY(-1px);
        }

        .chat-input-area {
            padding: 24px 32px;
            background: white;
            border-top: 1px solid #f1f5f9;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            padding: 4px;
            transition: all 0.2s ease;
        }

        .input-container:focus-within {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .chat-input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            outline: none;
            font-size: 14px;
            color: #374151;
        }

        .chat-input::placeholder {
            color: #9ca3af;
        }

        .input-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .mic-btn {
            background: #f3f4f6;
            color: #6b7280;
        }

        .mic-btn:hover {
            background: #e5e7eb;
            transform: scale(1.05);
        }

        .send-btn {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .footer-text {
            text-align: center;
            font-size: 11px;
            color: #9ca3af;
            margin-top: 16px;
        }

        /* Right Sidebar */
        .right-sidebar {
            width: 280px;
            background: white;
            border-left: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
        }

        .history-header {
            padding: 24px;
            border-bottom: 1px solid #f1f5f9;
        }

        .history-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
        }

        .history-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .history-item {
            background: #f8fafc;
            border: 1px solid #f1f5f9;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: #eff6ff;
            border-color: #dbeafe;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .history-item-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .history-item-preview {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .history-item-time {
            font-size: 11px;
            color: #9ca3af;
        }

        .history-actions {
            padding: 16px;
            border-top: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .new-chat-btn {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
        }

        .clear-btn {
            background: #f8fafc;
            color: #6b7280;
            border: 1px solid #e2e8f0;
        }

        .clear-btn:hover {
            background: #f1f5f9;
            color: #374151;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-icon {
            width: 24px;
            height: 24px;
            color: #2563eb;
            margin-right: 12px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: #374151;
        }

        .parameters-table {
            margin-bottom: 24px;
        }

        .parameter-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .parameter-label {
            width: 120px;
            font-size: 13px;
            font-weight: 500;
            color: #4b5563;
        }

        .parameter-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
        }

        .parameter-select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            background: white;
        }

        .confidence-badge {
            background: #fef2f2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.secondary {
            background: #f8fafc;
            color: #6b7280;
            border: 1px solid #e2e8f0;
        }

        .modal-btn.secondary:hover {
            background: #f1f5f9;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .modal-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #2563eb, #7c3aed);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #1d4ed8, #6d28d9);
        }

        .hidden {
            display: none;
        }

        /* URL Input Container */
        .url-input-container {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .url-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .url-submit {
            padding: 12px 16px;
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .url-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Sidebar -->
        <div class="left-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">RAG CHATBOT</div>
                <div class="title-underline"></div>
            </div>
            
            <div class="sidebar-content">
                <!-- Upload Tabs -->
                <div class="upload-tabs">
                    <div class="tab active" onclick="switchTab('pdf')">PDF Upload</div>
                    <div class="tab" onclick="switchTab('url')">URL Input</div>
                </div>

                <!-- PDF Upload -->
                <div id="pdf-tab" class="upload-section">
                    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">ðŸ“„</div>
                        <div style="font-size: 14px; color: #6b7280; font-weight: 500;">Click or drag PDF here...</div>
                        <input type="file" id="fileInput" accept=".pdf" style="display: none;">
                    </div>
                </div>

                <!-- URL Input -->
                <div id="url-tab" class="upload-section hidden">
                    <div class="url-input-container">
                        <input type="url" class="url-input" id="urlInput" placeholder="Enter URL...">
                        <button class="url-submit" id="urlSubmitBtn">Submit</button>
                    </div>
                </div>

                <!-- OCR Settings -->
                <div class="section">
                    <div class="section-title">
                        <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        OCR Settings
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox" id="enableOCR" checked>
                        <label for="enableOCR" class="checkbox-label">Enable OCR for scanned PDFs</label>
                    </div>

                    <div class="form-group">
                        <input type="number" class="form-input" id="ocrPages" value="17" placeholder="OCR pages (e.g., 8-20)">
                    </div>

                    <div class="form-group">
                        <input type="text" class="form-input" id="popplerPath" placeholder="Poppler bin path (optional)">
                    </div>

                    <div class="form-group">
                        <input type="text" class="form-input" id="tesseractPath" placeholder="Tesseract executable path (optional)">
                    </div>

                    <div class="form-group">
                        <input type="text" class="form-input" id="userLocation" value="Chennai, Tamil Nadu, India" placeholder="Location">
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" class="checkbox" id="disableEnrichment">
                        <label for="disableEnrichment" class="checkbox-label">Disable external enrichment</label>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="section">
                    <div class="section-title">
                        <svg class="section-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Quick Actions
                    </div>
                    
                    <div class="quick-actions">
                        <button class="action-btn purple" id="summarizeBtn">Summarize Document</button>
                        <button class="action-btn green" id="boostAutoBtn">Boost Knowledge â†’ Boost Automotive</button>
                    </div>
                </div>

                <!-- Status -->
                <div class="status-section">
                    <div class="status-title">Status</div>
                    <div class="status-message">Summary error: 400: No knowledge base loaded</div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="main-chat">
            <div class="chat-header">
                <div class="chat-title">AI Sales Consultant</div>
            </div>

            <div class="chat-messages" id="chatMessages">
                <!-- Welcome Message -->
                <div class="message">
                    <div class="message-row">
                        <div class="avatar bot">ðŸ¤–</div>
                        <div class="message-content">
                            <p class="message-text">Hello! I'm your medicine support assistant. I can help you find information from your uploaded documents. What would you like to know?</p>
                            <div class="message-timestamp">10:52:56 PM</div>
                        </div>
                    </div>
                </div>

                <!-- Sample User Message -->
                <div class="message">
                    <div class="message-row user">
                        <div class="avatar user">ðŸ‘¤</div>
                        <div class="message-content user">
                            <p class="message-text">What are the side effects of the medication mentioned in the guidelines?</p>
                            <div class="message-timestamp">10:52:56 PM</div>
                        </div>
                    </div>
                </div>

                <!-- Sample Bot Response -->
                <div class="message">
                    <div class="message-row">
                        <div class="avatar bot">ðŸ¤–</div>
                        <div class="message-content">
                            <p class="message-text">Based on the Medical Guidelines document, the common side effects include nausea, dizziness, and fatigue. However, I must emphasize that this information is for reference only and should not replace professional medical advice.</p>
                            <div class="page-references">
                                <div class="page-ref">ðŸ“„ Page 12 (94%)</div>
                                <div class="page-ref">ðŸ“„ Page 15 (87%)</div>
                            </div>
                            <div class="escalate-btn">ðŸš¨ Escalate to Human</div>
                            <div class="message-timestamp">10:52:56 PM</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Replies -->
            <div class="quick-replies">
                <div class="quick-reply-buttons">
                    <div class="quick-reply" onclick="addQuickReply('Key Features')">Key Features</div>
                    <div class="quick-reply" onclick="addQuickReply('Pricing Info')">Pricing Info</div>
                    <div class="quick-reply" onclick="addQuickReply('Where to Buy')">Where to Buy</div>
                    <div class="quick-reply" onclick="addQuickReply('Safety Info')">Safety Info</div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-area">
                <div class="input-container">
                    <input type="text" class="chat-input" placeholder="Ask about your documents..." id="messageInput">
                    <button class="input-btn mic-btn" id="micBtn">ðŸŽ¤</button>
                    <button class="input-btn send-btn" id="sendBtn" onclick="sendMessage()">âž¤</button>
                </div>
                <div class="footer-text">
                    Powered by RAG Technology â€¢ Enterprise Security â€¢ Multi-Modal AI
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <div class="history-header">
                <div class="history-title">
                    <svg style="width: 16px; height: 16px; margin-right: 8px; color: #2563eb;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Chat History
                </div>
            </div>

            <div class="history-content" id="historyList"></div>

            <div class="history-actions">
                <button class="history-btn new-chat-btn" id="newChatBtn">+ New Chat</button>
                <button class="history-btn clear-btn" id="clearHistoryBtn">Clear History</button>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay hidden" id="analysisModal">
        <div class="modal">
            <div class="modal-header">
                <svg class="modal-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <div class="modal-title">Document Analysis Complete</div>
            </div>

            <div class="parameters-table">
                <div class="parameter-row">
                    <div class="parameter-label">Category</div>
                    <select class="parameter-select" id="categorySelect">
                        <option selected>Other</option>
                        <option>Automotive</option>
                        <option>Mobile</option>
                        <option>Laptop</option>
                        <option>Automotive Accessories</option>
                        <option>Furniture</option>
                        <option>Home Appliances</option>
                        <option>Fashion Clothes</option>
                        <option>Sports Equipment</option>
                    </select>
                    <div class="confidence-badge">confidence low</div>
                </div>
                <div class="parameter-row">
                    <div class="parameter-label">Brand</div>
                    <input type="text" class="parameter-input" placeholder="Honda, Toyota">
                </div>
                <div class="parameter-row">
                    <div class="parameter-label">Model</div>
                    <input type="text" class="parameter-input" placeholder="Elevate, Camry">
                </div>
                <div class="parameter-row">
                    <div class="parameter-label">Full Product Name</div>
                    <input type="text" class="parameter-input" value="Detected product name">
                    <div class="confidence-badge">low confidence</div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal()">Re-upload</button>
                <button class="modal-btn primary" onclick="confirmAnalysis()">Confirm & Continue</button>
            </div>
        </div>
    </div>

    <script>
        let isTyping = false;
        // Prefer same-origin when served by FastAPI (port 8000); otherwise fall back to http://localhost:8000
        const API_BASE = (window.API_BASE || (location.port === '8000' ? '/api' : 'http://localhost:8000/api'));
        
        // Small helpers
        const qs = (sel, root=document) => root.querySelector(sel);
        const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
        const escapeHtml = (s='') => s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
        
        function showStatus(msg, type='info') {
            const box = document.querySelector('.status-message');
            if (!box) return;
            box.textContent = msg;
            box.style.color = type === 'error' ? '#b91c1c' : (type === 'success' ? '#166534' : '#374151');
        }
        function setChatEnabled(enabled) {
            const input = qs('#messageInput');
            const sendBtn = qs('.send-btn');
            if (input) input.disabled = !enabled;
            if (sendBtn) sendBtn.disabled = !enabled;
        }
        async function api(path, options={}) {
            const res = await fetch(`${API_BASE}${path}`, options);
            const data = await res.json().catch(() => ({}));
            if (!res.ok) throw new Error(data.detail || data.error || res.statusText);
            return data;
        }

        // --- Chat session state (frontend only, non-invasive) ---
        const Session = {
            current: null,
            new() {
                this.current = { id: `local-${Date.now()}`, hasMessages: false, createdAt: Date.now(), title: '', messages: [] };
            },
            reset() { this.current = null; }
        };
        Session.new();

        function timeAgo(ts) {
            const s = Math.floor((Date.now() - ts) / 1000);
            if (s < 60) return 'just now';
            const m = Math.floor(s/60); if (m < 60) return `${m} min ago`;
            const h = Math.floor(m/60); if (h < 24) return `${h} hour${h>1?'s':''} ago`;
            const d = Math.floor(h/24); return `${d} day${d>1?'s':''} ago`;
        }

        // Simple client-side summarizer for short session titles
        const STOPWORDS = new Set(['the','a','an','and','or','but','to','of','in','on','for','with','about','what','which','is','are','was','were','how','does','do','can','could','please','tell','me']);
        function normalizeText(t) { return (t||'').toLowerCase().replace(/https?:\/\S+/g,'').replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim(); }
        function titleCase(str) { return str.replace(/\w\S*/g, w => w.charAt(0).toUpperCase()+w.slice(1)); }
        function computeShortTitle(messages) {
            // Prefer first user message; otherwise combine last few
            const firstUser = messages?.find(m => m.role==='user' && m.text);
            const base = firstUser?.text || (messages?.slice(-3).map(m=>m.text).join(' ')||'').slice(0,160);
            const norm = normalizeText(base);
            const words = norm.split(' ').filter(w => w && !STOPWORDS.has(w));
            const top = words.slice(0,4).join(' ');
            const result = titleCase(top || (firstUser?.text||'Chat').split(' ').slice(0,4).join(' '));
            return result;
        }
        function sessionAddMessage(role, text) {
            if (!Session.current) Session.new();
            Session.current.messages.push({ role, text });
        }
        function updateHistoryTitle() {
            if (!Session.current || !Session.current.hasMessages) return;
            const title = computeShortTitle(Session.current.messages);
            const div = document.querySelector(`.history-item[data-session-id="${Session.current.id}"]`);
            if (div) {
                const titleEl = div.querySelector('.history-item-title');
                const timeEl = div.querySelector('.history-item-time');
                if (titleEl) titleEl.textContent = title;
                if (timeEl) timeEl.textContent = timeAgo(Date.now());
            }
            Session.current.title = title;
        }

        function ensureHistoryEntryCreated(summaryText) {
            const list = document.getElementById('historyList');
            if (!list) return;
            const title = (summaryText || '').trim().slice(0, 60) || 'New Chat';
            if (!Session.current) Session.new();
            if (!Session.current.hasMessages) {
                // Create card only on first real user message
                const div = document.createElement('div');
                div.className = 'history-item';
                div.dataset.sessionId = Session.current.id;
                div.innerHTML = `
                    <div class="history-item-title">${escapeHtml(title)}</div>
                    <div class="history-item-time">${timeAgo(Session.current.createdAt)}</div>
                `;
                // Click loads session via backend endpoints (if available)
                div.addEventListener('click', async () => {
                    const sid = div.dataset.sessionId;
                    const paths = [`/sessions/${sid}`, `/chat/sessions/${sid}`, `/history/sessions/${sid}`];
                    for (const p of paths) {
                        try {
                            const data = await api(p, { method: 'GET' });
                            const messages = data?.messages || data?.history || [];
                            const container = document.getElementById('chatMessages');
                            container.innerHTML = '';
                            messages.forEach(m => addMessage(m.text || m.message || '', m.role === 'user' ? 'user' : 'bot', m.pages || []));
                            return;
                        } catch(_) {}
                    }
                });
                list.prepend(div);
                Session.current.hasMessages = true;
                Session.current.title = title;
            } else {
                // Update existing card (only title/time)
                const div = document.querySelector(`.history-item[data-session-id="${Session.current.id}"]`);
                if (div) {
                    const titleEl = div.querySelector('.history-item-title');
                    const timeEl = div.querySelector('.history-item-time');
                    if (titleEl) titleEl.textContent = title;
                    if (timeEl) timeEl.textContent = timeAgo(Date.now());
                }
            }
        }

        function switchTab(tab) {
            // Update tab appearance
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Show/hide content
            document.getElementById('pdf-tab').classList.toggle('hidden', tab !== 'pdf');
            document.getElementById('url-tab').classList.toggle('hidden', tab !== 'url');
        }

        function addQuickReply(text) {
            document.getElementById('messageInput').value = text;
            document.getElementById('messageInput').focus();
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            // Add user message locally
            addMessage(message, 'user');
            sessionAddMessage('user', message);
            input.value = '';

            // Create/update history entry only when first user message is sent
            ensureHistoryEntryCreated(computeShortTitle(Session.current.messages));

            // Call backend chat
            showTypingIndicator();
            try {
                const data = await api('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                hideTypingIndicator();
                addMessage(data.response || 'No response', 'bot', data.pages || []);
                sessionAddMessage('bot', data.response || 'No response');
                updateHistoryTitle();
                if (data.used_external) {
                    showStatus('Answer enhanced with external sources', 'success');
                }
            } catch (err) {
                hideTypingIndicator();
                addMessage(`Error: ${escapeHtml(err.message)}`, 'bot');
                showStatus(err.message, 'error');
            }
        }

        function addMessage(text, type, pages=[]) {
            const messagesContainer = document.getElementById('chatMessages');
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const avatar = type === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–';
            const avatarClass = type === 'user' ? 'user' : 'bot';
            const contentClass = type === 'user' ? 'user' : '';
            const rowClass = type === 'user' ? 'user' : '';

            const refsHtml = (Array.isArray(pages) && pages.length)
                ? `<div class="page-references">${pages.map(p => `<div class=\"page-ref\">ðŸ“„ Page ${escapeHtml(String(p.page||p))} (${escapeHtml(String(p.score||''))})</div>`).join('')}</div>`
                : '';
            
            messageDiv.innerHTML = `
                <div class="message-row ${rowClass}">
                    <div class="avatar ${avatarClass}">${avatar}</div>
                    <div class="message-content ${contentClass}">
                        <p class="message-text">${escapeHtml(text)}</p>
                        ${refsHtml}
                        <div class="message-timestamp">${timestamp}</div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addBotResponse() {
            const messagesContainer = document.getElementById('chatMessages');
            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            messageDiv.innerHTML = `
                <div class="message-row">
                    <div class="avatar bot">ðŸ¤–</div>
                    <div class="message-content">
                        <p class="message-text">Based on the Medical Guidelines document, the common side effects include nausea, dizziness, and fatigue. However, I must emphasize that this information is for reference only and should not replace professional medical advice.</p>
                        <div class="page-references">
                            <div class="page-ref">ðŸ“„ Page 12 (94%)</div>
                            <div class="page-ref">ðŸ“„ Page 15 (87%)</div>
                        </div>
                        <div class="escalate-btn">ðŸš¨ Escalate to Human</div>
                        <div class="message-timestamp">${timestamp}</div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Show analysis modal after a delay
            setTimeout(() => {
                document.getElementById('analysisModal').classList.remove('hidden');
            }, 1000);
        }

        function showTypingIndicator() {
            if (isTyping) return;
            isTyping = true;

            const messagesContainer = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="avatar bot">ðŸ¤–</div>
                <div class="typing-dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            isTyping = false;
        }

        function closeModal() {
            document.getElementById('analysisModal').classList.add('hidden');
        }

        async function confirmAnalysis() {
            document.getElementById('analysisModal').classList.add('hidden');
            try {
                const modal = document.getElementById('analysisModal');
                const brand = (qs('.parameter-row input[placeholder="Honda, Toyota"]').value || '').trim();
                const model = (qs('.parameter-row input[placeholder="Elevate, Camry"]').value || '').trim();
                const product_name = (qs('.parameter-row input[value]')?.value || '').trim();
                const categoryLabel = (qs('.parameter-row select')?.value || '').toLowerCase();
                const categoryMap = {
                    'other': 'other',
                    'automotive': 'automotive',
                    'mobile': 'mobile',
                    'laptop': 'laptop',
                    'automotive accessories': 'automotive_accessories',
                    'furniture': 'furniture',
                    'home appliances': 'home_appliances',
                    'fashion clothes': 'fashion_clothes',
                    'sports equipment': 'sports_equipment'
                };
                const category = categoryMap[categoryLabel] || categoryLabel;
                const pdf_path = (window.__lastUploadedPath || '').trim();

                const form = new FormData();
                form.append('pdf_path', pdf_path);
                form.append('brand', brand);
                form.append('model', model);
                form.append('category', category);
                form.append('product_name', product_name);

                const res = await api('/confirm-and-process', { method: 'POST', body: form });
                showStatus(res.message || 'Ready for chat', 'success');
                setChatEnabled(true);
            } catch (err) {
                showStatus(err.message, 'error');
            }
        }

        // Enter key support
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        // URL submit -> POST /api/setup-urls
        document.getElementById('urlSubmitBtn').addEventListener('click', async () => {
            const raw = document.getElementById('urlInput').value.trim();
            if (!raw) return;
            const urls = raw.split(/\s|,|;+/).map(u => u.trim()).filter(Boolean);
            try {
                const res = await api('/setup-urls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls })
                });
                showStatus(res.message || 'URLs processed', 'success');
                setChatEnabled(true);
            } catch (err) {
                showStatus(err.message, 'error');
            }
        });

        // Settings update -> PUT /api/settings when toggles/inputs change
        function collectSettings() {
            return {
                user_location: document.getElementById('userLocation')?.value || undefined,
                disable_external: document.getElementById('disableEnrichment')?.checked ?? undefined,
                ocr_settings: {
                    enable_ocr: document.getElementById('enableOCR')?.checked ?? true,
                    ocr_pages: parseInt(document.getElementById('ocrPages')?.value || '8', 10),
                    poppler_path: document.getElementById('popplerPath')?.value || '',
                    tesseract_cmd: document.getElementById('tesseractPath')?.value || ''
                }
            };
        }
        const settingsFields = ['userLocation','disableEnrichment','enableOCR','ocrPages','popplerPath','tesseractPath'];
        settingsFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('change', async () => {
                try {
                    const payload = collectSettings();
                    const res = await api('/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showStatus('Settings updated', 'success');
                } catch (err) {
                    showStatus(err.message, 'error');
                }
            });
        });

        // Summarize -> POST /api/summarize
        document.getElementById('summarizeBtn').addEventListener('click', async () => {
            try {
                const res = await api('/summarize', { method: 'POST' });
                addMessage(res.summary || 'Summary generated.', 'bot');
            } catch (err) {
                showStatus(err.message, 'error');
            }
        });

        // Boost Automotive -> POST /api/boost-automotive
        document.getElementById('boostAutoBtn').addEventListener('click', async (e) => {
            const btn = e.currentTarget;
            btn.classList.add('loading');
            try {
                const res = await api('/boost-automotive', { method: 'POST' });
                showStatus(res.message || 'Automotive knowledge boosted', 'success');
            } catch (err) {
                showStatus(err.message, 'error');
            } finally {
                btn.classList.remove('loading');
            }
        });

        // On load: fetch status and hydrate chat + history
        (async () => {
            try {
                const status = await api('/status');
                // Load chat history if backend supports it
                await loadChatHistory();
                await loadHistorySidebar();
                // Optionally greet based on product info
                if (status && status.product_name) {
                    const info = await api('/product-info');
                    if (info?.product_name) {
                        showStatus(`Loaded ${info.product_name}.`, 'success');
                    }
                }
            } catch (_) {}
        })();

        async function loadChatHistory() {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            container.innerHTML = '';
            Session.current && (Session.current.messages = []);
            // Try common endpoints for chat messages
            const endpoints = ['/history', '/chat/history', '/messages'];
            for (const ep of endpoints) {
                try {
                    const res = await api(ep, { method: 'GET' });
                    const items = res?.history || res?.messages || res || [];
                    if (Array.isArray(items) && items.length) {
                        items.forEach(m => {
                            const text = m.text || m.message || '';
                            const role = m.role === 'user' ? 'user' : 'bot';
                            addMessage(text, role, m.pages || []);
                            sessionAddMessage(role, text);
                        });
                        // Only create history if thereâ€™s a user message
                        const firstUser = items.find(x => (x.role === 'user') && (x.text || x.message));
                        if (firstUser) {
                            ensureHistoryEntryCreated(computeShortTitle(Session.current.messages));
                        }
                        return;
                    }
                } catch (_) { /* continue */ }
            }
        }

        async function loadHistorySidebar() {
            const list = document.getElementById('historyList');
            if (!list) return;
            list.innerHTML = '';
            // Try common endpoints for sessions
            const endpoints = ['/sessions', '/chat/sessions', '/history/sessions'];
            for (const ep of endpoints) {
                try {
                    const res = await api(ep, { method: 'GET' });
                    const items = res?.sessions || res || [];
                    if (Array.isArray(items) && items.length) {
                        items.forEach(s => {
                            const div = document.createElement('div');
                            div.className = 'history-item';
                            const title = s.title || s.name || 'Chat Session';
                            const preview = s.last_message || s.preview || '';
                            const time = s.updated_at || s.time || '';
                            div.innerHTML = `
                                <div class="history-item-title">${escapeHtml(title)}</div>
                                <div class="history-item-preview">${escapeHtml(preview)}</div>
                                <div class="history-item-time">${escapeHtml(String(time))}</div>
                            `;
                            div.addEventListener('click', async () => {
                                // Load a specific session if endpoint exists
                                const sid = s.id || s.session_id;
                                if (!sid) return;
                                const paths = [`/sessions/${sid}`, `/chat/sessions/${sid}`, `/history/sessions/${sid}`];
                                for (const path of paths) {
                                    try {
                                        const data = await api(path, { method: 'GET' });
                                        const messages = data?.messages || data?.history || [];
                                        const container = document.getElementById('chatMessages');
                                        container.innerHTML = '';
                                        messages.forEach(m => addMessage(m.text || m.message || '', m.role === 'user' ? 'user' : 'bot', m.pages || []));
                                        return;
                                    } catch (_) {}
                                }
                            });
                            list.appendChild(div);
                        });
                        return;
                    }
                } catch (_) { /* continue */ }
            }
        }

        // New Chat & Clear History wiring
        function clearMessagesUI() {
            const container = document.getElementById('chatMessages');
            if (container) container.innerHTML = '';
        }
        async function tryApi(path, options) {
            try { return await api(path, options); } catch { return null; }
        }
        document.getElementById('newChatBtn').addEventListener('click', async () => {
            // Try backend reset endpoints if they exist (non-breaking if missing)
            const tried = await (tryApi('/new-chat', { method: 'POST' }) || tryApi('/reset', { method: 'POST' }) || tryApi('/chat/reset', { method: 'POST' }));
            // Clear UI state
            clearMessagesUI();
            document.getElementById('messageInput').value = '';
            // Start a fresh local session but DO NOT add to history until first user message
            Session.new();
            showStatus('Started a new chat session', 'success');
        });
        document.getElementById('clearHistoryBtn').addEventListener('click', async () => {
            // Try backend clear-history endpoints if they exist
            const tried = await (tryApi('/clear-history', { method: 'POST' }) || tryApi('/history/clear', { method: 'POST' }) || tryApi('/chat/history/clear', { method: 'POST' }));
            // Clear UI history/messages
            clearMessagesUI();
            await loadHistorySidebar();
            showStatus('Chat history cleared', 'success');
        });

        // Speech recognition (browser) + Whisper fallback
        let mediaRecorder, audioChunks = [], mediaStream;
        let sr, srActive = false, interimBuffer = '';

        function pickMime() {
            const candidates = [
                'audio/webm;codecs=opus',
                'audio/webm',
                'audio/ogg;codecs=opus',
                'audio/mp4'
            ];
            for (const t of candidates) {
                if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) return t;
            }
            return 'audio/webm';
        }

        function hasSpeechRecognition() {
            return ('SpeechRecognition' in window) || ('webkitSpeechRecognition' in window);
        }
        function createSpeechRecognition() {
            const Ctor = window.SpeechRecognition || window.webkitSpeechRecognition;
            const rec = new Ctor();
            rec.lang = 'en'; // adjust or make configurable
            rec.continuous = true;
            rec.interimResults = true;
            rec.maxAlternatives = 1;
            return rec;
        }
        function startSpeechRecognition() {
            if (!hasSpeechRecognition()) return false;
            if (srActive) return true;
            sr = createSpeechRecognition();
            const input = document.getElementById('messageInput');
            interimBuffer = '';
            sr.onresult = (event) => {
                let finalText = '';
                let interimText = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalText += transcript + ' ';
                    } else {
                        interimText += transcript + ' ';
                    }
                }
                if (finalText) interimBuffer += finalText;
                // Continuously update input box
                input.value = (interimBuffer + interimText).trim();
            };
            sr.onerror = () => {};
            sr.onend = () => {
                // Auto-restart while active to keep continuous
                if (srActive) try { sr.start(); } catch(_) {}
            };
            try {
                sr.start();
                srActive = true;
                document.getElementById('micBtn').classList.add('active');
                showStatus('Listening... click mic to stop', 'info');
                return true;
            } catch(_) { return false; }
        }
        function stopSpeechRecognition() {
            srActive = false;
            try { sr && sr.stop(); } catch(_) {}
            document.getElementById('micBtn').classList.remove('active');
        }

        async function startWhisperRecording() {
            const btn = document.getElementById('micBtn');
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatus('Microphone not supported in this browser', 'error');
                return;
            }
            const mimeType = pickMime();
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(mediaStream, { mimeType });
            audioChunks = [];
            mediaRecorder.ondataavailable = e => e.data && e.data.size && audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                try {
                    const ext = mimeType.includes('ogg') ? 'ogg' : (mimeType.includes('mp4') ? 'm4a' : 'webm');
                    const blob = new Blob(audioChunks, { type: mimeType });
                    const form = new FormData();
                    form.append('file', blob, `speech.${ext}`);
                    form.append('lang', 'en');
                    const res = await fetch(`${API_BASE}/transcribe`, { method: 'POST', body: form });
                    const data = await res.json();
                    if (data && data.text) {
                        document.getElementById('messageInput').value = data.text;
                        showStatus('Transcription ready. Review and send.', 'success');
                    } else {
                        showStatus('No speech detected', 'error');
                    }
                } catch (err) {
                    showStatus('Transcription failed. Ensure faster-whisper and ffmpeg are installed.', 'error');
                } finally {
                    if (mediaStream) mediaStream.getTracks().forEach(t => t.stop());
                    mediaStream = null;
                }
            };
            mediaRecorder.start();
            btn.classList.add('active');
            showStatus('Recording... click mic again to stop', 'info');
        }
        function stopWhisperRecording() {
            const btn = document.getElementById('micBtn');
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            btn.classList.remove('active');
            showStatus('Processing audio...', 'info');
        }

        document.getElementById('micBtn').addEventListener('click', async () => {
            // Prefer browser real-time recognition for continuous updates
            if (hasSpeechRecognition()) {
                if (!srActive) {
                    startSpeechRecognition();
                } else {
                    stopSpeechRecognition();
                }
            } else {
                // Fallback to Whisper: record once, transcribe on stop
                if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                    try { await startWhisperRecording(); } catch { showStatus('Microphone access denied', 'error'); }
                } else {
                    stopWhisperRecording();
                }
            }
        });

        // File upload handling -> POST /api/upload-pdf
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files || []);
            if (!files.length) return;
            try {
                const form = new FormData();
                files.forEach(f => form.append('files', f));
                showStatus('Uploading document...', 'info');

                // Step 1: upload with extraction to prefill modal
                const extracted = await api('/upload-pdf-with-extraction', { method: 'POST', body: form });
                const first = extracted.files?.[0];
                if (first) {
                    window.__lastUploadedPath = first.pdf_path;
                    // Prefill modal fields if present
                    const params = first.parameters || {};
                    const brandEl = qs('.parameter-row input[placeholder="Honda, Toyota"]');
                    const modelEl = qs('.parameter-row input[placeholder="Elevate, Camry"]');
                    const nameEl = qs('.parameter-row input[value]');
                    const catEl = qs('.parameter-row select');
                    if (brandEl && params.brand) brandEl.value = params.brand;
                    if (modelEl && params.model) modelEl.value = params.model;
                    if (nameEl && params.product) nameEl.value = params.product;
                    if (catEl) catEl.value = (params.category ? (params.category.charAt(0).toUpperCase()+params.category.slice(1)) : 'Other');
                    document.getElementById('analysisModal').classList.remove('hidden');
                }
            } catch (err) {
                // Fallback to old upload if extraction fails
                try {
                    const fallback = new FormData();
                    files.forEach(f => fallback.append('files', f));
                    const result = await api('/upload-pdf', { method: 'POST', body: fallback });
                    showStatus(result.message || 'Uploaded', 'success');
                    setChatEnabled(true);
                } catch (e2) {
                    showStatus(err.message || String(e2), 'error');
                }
            }
        });
    </script>
</body>
</html>